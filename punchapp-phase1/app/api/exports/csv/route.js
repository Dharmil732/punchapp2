import { serverAdmin } from '@/lib/serverAdmin'; import { stringify } from 'csv-stringify/sync'; export async function POST(req){ const sb=serverAdmin(); const {start,end}=await req.json(); const {data,error}=await sb.rpc('payroll_with_rates_and_ot',{p_start:start,p_end:end}); if(error) return new Response(error.message,{status:500}); const rows=(data||[]).map(r=>({name:r.name,email:r.email,code:r.employee_code,base_hours:r.base_hours,ot_hours:r.ot_hours,currency:r.currency,rate:r.rate_per_hour,base_amount:r.amount_base,ot_amount:r.amount_ot,total:r.amount_total})); const csv=stringify(rows,{header:true}); return new Response(csv,{headers:{'Content-Type':'text/csv','Content-Disposition':`attachment; filename="payroll_${start}_${end}.csv"`}}); }

import { serverAdmin } from '@/lib/serverAdmin'; import XLSX from 'xlsx'; export async function POST(req){ const sb=serverAdmin(); const {start,end}=await req.json(); const {data,error}=await sb.rpc('payroll_with_rates_and_ot',{p_start:start,p_end:end}); if(error) return new Response(error.message,{status:500}); const rows=(data||[]).map(r=>({Name:r.name,Email:r.email,Code:r.employee_code,BaseHours:r.base_hours,OTHours:r.ot_hours,Curr:r.currency,Rate:r.rate_per_hour,Base$:r.amount_base,OT$:r.amount_ot,Total$:r.amount_total})); const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Payroll'); const buf=XLSX.write(wb,{type:'buffer',bookType:'xlsx'}); return new Response(buf,{headers:{'Content-Type':'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','Content-Disposition':`attachment; filename="payroll_${start}_${end}.xlsx"`}}); }
